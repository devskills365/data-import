<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/form_style.css') }}">

    <script>
        let dimensionCount = 0;
    
        // Ajouter une nouvelle dimension
        function addDimension() {
            dimensionCount++;
            const container = document.getElementById("dimensionsContainer");
    
            const dimensionDiv = document.createElement("div");
            dimensionDiv.className = "dimension-group";
            dimensionDiv.id = `dimensionGroup_${dimensionCount}`;
    
            dimensionDiv.innerHTML = `
                <label for="dimension_${dimensionCount}">Dimension:</label>
                <select name="dimensions[]" id="dimension_${dimensionCount}" onchange="loadModalites(${dimensionCount})" required>
                    <option value="">Sélectionnez une dimension</option>
                </select>
    
                <div id="modalitesContainer_${dimensionCount}" class="modalites-container">
                    <!-- Boutons radio des modalités -->
                </div>
    
                <button type="button" onclick="removeDimension(${dimensionCount})" class="remove-dimension-btn">Supprimer</button>
            `;
    
            container.appendChild(dimensionDiv);
    
            // Charger les dimensions
            fetch('/get_dimensions')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById(`dimension_${dimensionCount}`);
                    data.forEach(dimension => {
                        const option = document.createElement("option");
                        option.value = dimension.idDimensions;
                        option.textContent = dimension.nomDimension;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error("Erreur lors du chargement des dimensions :", error));
        }
    
        // Supprimer une dimension
        function removeDimension(id) {
            const dimensionDiv = document.getElementById(`dimensionGroup_${id}`);
            dimensionDiv.remove();
        }
    
        // Charger les modalités pour une dimension sélectionnée
        function loadModalites(dimensionId) {
            const dimensionSelect = document.getElementById(`dimension_${dimensionId}`);
            const dimensionValue = dimensionSelect.value;
    
            fetch(`/get_modalites/${dimensionValue}`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById(`modalitesContainer_${dimensionId}`);
                    container.innerHTML = ''; // Réinitialiser
    
                    data.forEach(modalite => {
                        const radio = `
                            <label>
                                <input type="radio" name="modalites_${dimensionId}" value="${modalite.idModalites}" required>
                                ${modalite.nomModalites}
                            </label>
                        `;
                        container.innerHTML += radio;
                    });
                })
                .catch(error => console.error("Erreur lors du chargement des modalités :", error));
        }
    
        // Activer l'autocomplétion pour les indicateurs
        function setupAutocomplete() {
            const input = document.getElementById("nomIndicateur");
            input.addEventListener("input", function () {
                const query = input.value;
    
                fetch(`/search_indicateur?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        const datalist = document.getElementById("indicateurOptions");
                        datalist.innerHTML = ''; // Réinitialiser
    
                        data.forEach(indicateur => {
                            const option = document.createElement("option");
                            option.value = indicateur.nomIndicateur;
                            datalist.appendChild(option);
                        });
                    })
                    .catch(error => console.error("Erreur lors de l'autocomplétion :", error));
            });
        }
    
        document.addEventListener("DOMContentLoaded", setupAutocomplete);
    </script>
    
</head>
<body>
    <form action="/add_data" id="dataForm">
        <label for="nomIndicateur">Indicateur:</label>
        <input list="indicateurOptions" id="nomIndicateur" name="nomIndicateur" required>
        <datalist id="indicateurOptions"></datalist>
        <br>

        <label for="idAnnees">Année:</label>
        <select id="idAnnees" name="idAnnees" required>
            <option value="">Sélectionnez une année</option>
            {% for annee in annees %}
                <option value="{{ annee.idAnnees }}">{{ annee.valAnnees }}</option>
            {% endfor %}
        </select>
        <br>

        <label for="valeur">Valeur:</label>
        <input type="number" step="1" name="valeur" id="valeur" required>
        <br>

        <div id="dimensionsContainer">
            <!-- Conteneur pour les dimensions et leurs modalités -->
        </div>

        <button type="button" onclick="addDimension()">Ajouter une dimension</button>
        <button type="submit">Soumettre</button>
    </form>
</body>
</html>
